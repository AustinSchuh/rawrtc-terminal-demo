<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RAWRTC Web Terminal Demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0" />
    <link rel="stylesheet" href="main.css" type="text/css" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="init.js"></script>
    <script src="init-mobile.js"></script>
    <script src="sdp.js"></script>
    <script src="webrtc-rawrtc.js"></script>
    <script src="rtcEvents.js"></script>
    <script src="socketAdapter.js"></script>
</head>
<body>
    <button type="button" onclick="startWS();">Start (WebSocket)</button>
    <input type="text" size="50" value="ws://217.160.182.235:9765/shell-o-mat/1" id="ws-url" />
    <div id="content"></div>
    <script type="text/javascript">

        // Create instance
        let peer = new ControllingPeer();
        peer.createPeerConnection();

		// Set WebRTC adapter
		rtcEvents.adapter = socketWebRTCAdapter;

		// Create terminal data channel and apply events
        let dataChannel = peer.createDataChannel(peer.pc.createDataChannel('terminal-1', {
            ordered: true
        }));
        let eventNames = ['onopen', 'onerror', 'onclose', 'onmessage'];
        for (let i = 0; i < eventNames.length; i++) {
            let eName = eventNames[i];
            if (rtcEvents[eName]) {
                dataChannel[eName] = rtcEvents[eName].bind(rtcEvents, dataChannel);
            }
        }

		// Add startup event to WebRTC adapter
        socketWebRTCAdapter.on('startup', function() {
            initTerminal(socketWebRTCAdapter);
            socketWebRTCAdapter.receive({channel: 'console', data: 'Connected.'});
        });

        // Apply local parameters
        peer.getLocalParameters()
        .then((parameters) => {
            console.log('Local parameters:', parameters);
        });

        // Make peer globally available
        window.peer = peer;

        let startWS = () => {
            // Create WebSocket connection
            let ws = new WebSocket(document.getElementById('ws-url').value);

            // Bind WebSocket events
            ws.onopen = function(event) {
                console.log('WS connection open');

                // Send local parameters
                peer.getLocalParameters().then((parameters) => {
                    console.info('Sending local parameters');
                    ws.send(JSON.stringify(parameters));
                });
            };

            ws.onerror = function(event) {
                console.log('WS connection error:', event);
            };

            ws.onclose = function(event) {
                console.log('WS connection closed');
            };

            ws.onmessage = function(event) {
                let length = event.data.size || event.data.byteLength || event.data.length;
                console.log('WS message of', length, 'bytes received');

                // Parse remote parameters
                let parameters = JSON.parse(event.data);
                console.log('Remote parameters:', parameters);
                peer.setRemoteParameters(parameters)
                .catch((error) => {
                    console.error(error);
                });

                // Close WebSocket connection
                ws.close();
            };
        };
    </script>
</body>
</html>
